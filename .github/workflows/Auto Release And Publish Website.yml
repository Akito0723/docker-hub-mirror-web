name: Auto Release And Deploy Website

on:
  - workflow_dispatch

jobs:
  build-release-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Get next version
        id: next-latest-release
        uses: reecetech/version-increment@2024.4.4
        with:
          scheme: calver

      - name: Build With yarn
        id: build-with-yan
        uses: Akito0723/auto-deploy/.github/workflows/Auto Build With yarn.yml@main
        with:
          node-version: "16.20.0"
          yarn-version: "1.22.19"
          tgz-file-name: "release-${{ steps.next-latest-release.outputs.v-version }}.tgz"

      - run: ls

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          tag_name: ${{ steps.next-latest-release.outputs.v-version }}
          name: Release ${{ steps.next-latest-release.outputs.v-version }}
          # 要上传的文件
          files: ./release-${{ steps.next-latest-release.outputs.v-version }}.tgz

      - name: Auto Deploy
        id: auto-deploy
        uses: Akito0723/auto-deploy/.github/workflows/Auto Deploy Website.yml@main
        with:
          tgz-file-name: release-${{ steps.next-latest-release.outputs.v-version }}.tgz
          deploy-path: "/var/www/docker-hub-mirror-web"

